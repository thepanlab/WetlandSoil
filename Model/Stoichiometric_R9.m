clear; clc
data=[0.04	0.03	0.03	0.13	0.16	0.13	0.02	0.02	0.02	0.00	0.00	0.00	0.14	0.12	0.13	0.49	0.56	0.62	0.00	0.00	0.00
0.16	0.13	0.17	1.15	0.96	1.05	0.59	0.65	0.61	0.00	0.00	0.00	0.26	0.28	0.29	0.77	0.72	0.60	0.02	0.01	0.03
0.35	0.34	0.41	2.15	1.83	2.32	1.05	1.07	1.12	0.00	0.00	0.00	0.29	0.34	0.28	0.76	0.69	0.67	0.05	0.03	0.03
0.67	0.63	0.63	3.19	2.99	3.15	2.16	2.11	2.08	0.00	0.00	0.00	0.16	0.15	0.18	0.76	0.79	0.85	0.10	0.10	0.09
0.90	0.78	0.84	3.98	3.57	3.88	2.57	2.54	2.65	0.00	0.00	0.00	0.15	0.16	0.13	0.98	0.90	1.06	0.18	0.15	0.13
0.92	0.82	0.90	4.18	3.82	4.16	2.62	2.63	2.75	0.00	0.00	0.00	0.08	0.12	0.11	0.94	0.87	1.09	0.16	0.17	0.20
0.04	0.03	0.03	0.13	0.16	0.13	0.02	0.02	0.02	0.00	0.00	0.39	0.14	0.12	0.13	0.53	0.65	0.65	0.00	0.00	0.00
0.22	0.23	0.22	1.18	1.09	1.09	0.28	0.23	0.25	0.58	0.34	0.36	0.20	0.28	0.30	0.55	0.64	0.61	0.01	0.00	0.00
0.39	0.34	0.37	2.12	1.82	2.25	0.28	0.27	0.27	0.84	0.88	1.19	0.29	0.35	0.29	0.68	0.51	0.61	0.01	0.01	0.01
0.54	0.50	0.49	3.13	3.11	3.10	0.56	0.47	0.50	1.02	0.88	1.19	0.28	0.33	0.35	0.74	0.73	0.73	0.02	0.08	0.09
0.55	0.53	0.51	4.23	4.39	4.21	0.69	0.60	0.63	1.26	1.35	1.34	0.32	0.35	0.31	1.87	2.05	1.86	0.10	0.15	0.14
0.56	0.52	0.50	4.38	4.61	4.50	0.78	0.67	0.71	1.57	1.65	1.73	0.30	0.33	0.37	2.03	1.78	1.92	0.11	0.10	0.11
0.04	0.03	0.03	0.13	0.16	0.13	0.02	0.02	0.02	0.00	0.00	0.00	0.14	0.12	0.13	0.49	0.56	0.62	0.00	0.00	0.00
0.07	0.07	0.07	0.77	0.61	0.74	0.08	0.08	0.08	0.00	0.00	0.00	0.13	0.12	0.13	0.59	0.52	0.54	0.00	0.00	0.00
0.11	0.09	0.12	2.21	2.42	2.34	0.07	0.08	0.07	0.00	0.00	0.00	0.12	0.12	0.12	0.34	0.35	0.34	0.00	0.00	0.01
0.25	0.20	0.24	4.92	5.15	4.60	0.08	0.08	0.08	0.00	0.00	0.00	0.11	0.12	0.19	0.28	0.27	0.28	0.00	0.00	0.00
0.40	0.31	0.32	6.60	6.61	6.36	0.08	0.08	0.08	0.00	0.00	0.00	0.09	0.10	0.16	0.32	0.22	0.49	0.00	0.00	0.00
0.50	0.35	0.35	6.82	6.88	6.91	0.08	0.08	0.08	0.00	0.00	0.00	0.13	0.09	0.12	0.22	0.18	0.17	0.00	0.00	0.00
0.04	0.03	0.03	0.13	0.16	0.13	0.02	0.02	0.02	0.00	0.00	0.00	0.00	0.12	0.13	0.49	0.56	0.62	0.00	0.00	0.00
0.05	0.05	0.06	0.94	0.75	1.06	0.06	0.06	0.05	0.00	0.00	0.00	0.14	0.12	0.14	0.51	0.58	0.53	0.00	0.00	0.00
0.13	0.11	0.14	2.38	2.00	2.67	0.07	0.08	0.07	0.00	0.00	0.00	0.10	0.14	0.11	0.67	0.55	0.77	0.00	0.00	0.00
0.24	0.24	0.25	5.22	4.14	4.60	0.07	0.08	0.07	0.02	0.01	0.01	0.11	0.14	0.10	0.50	0.52	0.48	0.00	0.00	0.00
0.30	0.29	0.30	6.96	6.55	7.01	0.08	0.08	0.08	0.02	0.02	0.02	0.15	0.13	0.09	0.29	0.23	0.24	0.00	0.00	0.00
0.33	0.34	0.34	7.62	6.91	7.67	0.08	0.08	0.08	0.03	0.02	0.02	0.10	0.13	0.13	0.16	0.20	0.24	0.00	0.00	0.00];

i=0;
j=0;
col=colormap(hsv(4));

t={'None','Sulfate','O2','Both'};

a=[0, 0, 4, 2, 0, -2, -4, 0, 0, 2; %H2
    6, 0, 2, 1, 1, 0, -1, 1, 1, 2; % Co2
    0, 0, 0, 0, 0, 0, 1, 1, -1, 0; % CH4
    0, 0, 0, 0, 0.5, 0.5, 0, 0, 0, 0; % H2S
    0, 2, 0, -1, -1, 0, 0, 0, 0, 0; % lactate
    0, 0, 2, 1, 1, 0, 0, -1, 0, 0; % acetate
    0, 0, 0, 0, 0, 0, 0, 0, 0, 1]; %butyrate
   % -1, -1, -1, -1, 0, 0, 0, 0, 0, 0, 0, -1, 0;];%glucose
   
l=size(a,1);
for c=1:4
  j=j+1;
  if c==1
      b=[zeros(l,1) a(:,2:4) zeros(l,2) a(:,7:8) zeros(l,1) a(:,10)];
  elseif c==2
      b=[zeros(l,1) a(:,2:8) zeros(l,1) a(:,10)];
  elseif c==3
      b=[a(:,1:4) zeros(l,2) a(:,7:9) a(:,10)];
  elseif c==4
      b=[a(:,1:10)];
  end
  for rep=1:3
    for d=1:6
      i=i+1;
      p(i,:)=data(((c-1)*6+d),[1 4 7 10 13 16 19 ]+rep-1); 
      sol2(:,i) = lsqnonneg(b,p(i,:)');  
      cm(i,:)=b*sol2(1:end,i);
      
      
    end
    R(rep)=goodnessOfFit(p(6,:)',cm(6,:)','NRMSE')
   
    subplot(2,2,j);plot(1:6,cm(i-5:i,1),':r',1:6,cm(i-5:i,2),':b',1:6,cm(i-5:i,3),':g',1:6,cm(i-5:i,4),':k',1:6,cm(i-5:i,5),'--r',1:6,cm(i-5:i,6),'--b',1:6,cm(i-5:i,7),'--g','LineWidth', 2);
    hold on; 
    plot(1:6,p(i-5:i,1),'*r',1:6,p(i-5:i,2),'*b',1:6,p(i-5:i,3),'*g',1:6,p(i-5:i,4),'*k',1:6,p(i-5:i,5),'or',1:6,p(i-5:i,6),'ob',1:6,p(i-5:i,7),'og')
    
   %subplot(2,2,j);plot([1:6],sol2(1,i-5:i),':r',[1:6],sol2(2,i-5:i),':b',[1:6],sol2(3,i-5:i),':g',[1:6],sol2(4,i-5:i),':k',[1:6],sol2(5,i-5:i),'--r',[1:6],sol2(6,i-5:i),'--b',[1:6],sol2(7,i-5:i),'--g', [1:6],sol2(8,i-5:i),'--k', [1:6],sol2(9,i-5:i),'-r',[1:6],sol2(10,i-5:i),'-b','LineWidth', 2);
   %hold on;
    
    
    axis([0 6 0 1.5]);
    xlabel('Days'); ylabel('Flux (mmoles)'); title({t{c};['NRMSE ' num2str(round(mean(R),3)) ' +/- ' num2str(round(std(R),3))]});
    
   end
  
  if c==1
  legend({'H2', 'CO2', 'CH4','H2S','lactate','acetate','butyrate'});
 % legend({'aerobic heterotroph', 'lactate fermentation', 'hydrogenic acetogenesis', 'Hydrogenic lactate oxidation','sulfidogenic lactate oxidation', 'sulfidogenic hydrogen oxidation','hydrogenic methanogenesis', 'acetoclastic methanogenesis', 'methane oxidation', 'butyrate production'})
end
end
  
